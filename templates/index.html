<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <h1>Welcome to the Budget Tracker App</h1>
    <p>Add and track your expenses here!</p>
    <a href="{{ url_for('add_transaction') }}">Add New Transaction</a>

    <!-- Filter Form -->
    <form action="{{ url_for('home') }}" method="get" style="margin-top: 1rem;">
        <label for="type_filter">Show:</label>
        <select id="type_filter" name="type_filter">
            <option value="all" {% if type_filter == 'all' %}selected{% endif %}>All</option>
            <option value="income" {% if type_filter == 'income' %}selected{% endif %}>Income</option>
            <option value="expense" {% if type_filter == 'expense' %}selected{% endif %}>Expense</option>
        </select>
        <button type="submit">Filter</button>
    </form>

    <!-- Export CSV Link -->
    <p><a href="{{ url_for('export_csv') }}">Export Transactions to CSV</a></p>

    <!-- Summary Section -->
    <h2>Summary</h2>
    <p>Total Income: ${{ total_income }}</p>
    <p>Total Expenses: ${{ total_expense }}</p>
    <p>Net Balance: ${{ net_balance }}</p>

    <!-- Income vs Expenses Chart -->
    <h2>Income vs Expenses</h2>
    <div id="chart"></div>
    <script>
        var chartData = {{ chart_json | safe }};
        console.log("Chart Data Debug:", chartData);

        if (Array.isArray(chartData)) {
            var data = [{
                x: chartData.map(d => d.category),
                y: chartData.map(d => d.amount),
                type: 'bar'
            }];

            Plotly.newPlot('chart', data, { title: 'Income vs Expenses' });
        } else {
            console.error("chartData is not an array:", chartData);
        }
    </script>

    <!-- Expense Breakdown Pie Chart -->
    <h2>Expenses by Category</h2>
    <div id="pie-chart"></div>
    <script>
        var categoryData = {{ category_json | safe }};
        console.log("Category Data Debug:", categoryData);

        if (Array.isArray(categoryData) && categoryData.length > 0) {
            var pieData = [{
                labels: categoryData.map(d => d.category),
                values: categoryData.map(d => d.amount),
                type: 'pie'
            }];

            Plotly.newPlot('pie-chart', pieData, { title: 'Expenses by Category' });
        } else {
            console.error("categoryData is not valid:", categoryData);
        }
    </script>

    <h2>Transactions</h2>
    {% if transactions %}
        <ul>
            {% for transaction in transactions %}
                <li>
                    {{ transaction.date }} - {{ transaction.category }} - ${{ transaction.amount }} - {{ transaction.type }}
                    | <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}">Edit</a>
                    | <a href="{{ url_for('delete_transaction', transaction_id=transaction.id) }}">Delete</a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No transactions found.</p>
    {% endif %}
</body>
</html>
